/* ==================== BLOK 1: KONFIGURASI USER DEFAULT ==================== */
const USER_CREDENTIALS = {
    username: 'admin',
    password: 'admin123'
};

/* ==================== BLOK 2: KONSTANTA DAN INISIALISASI ==================== */
const AUTH_KEY = 'urlShortenerAuth';
const STORAGE_KEY = 'shortenedUrls';
const CLICKS_KEY = 'urlClicks';
const ANALYTICS_KEY = 'analyticsData';

// Inisialisasi chart
let clickChart, analyticsChart, deviceChart;

/* ==================== BLOK 3: FUNGSI AUTHENTIKASI ==================== */
function checkAuth() {
    const auth = localStorage.getItem(AUTH_KEY);
    return auth === 'true';
}

function login(username, password) {
    if (username === USER_CREDENTIALS.username && password === USER_CREDENTIALS.password) {
        localStorage.setItem(AUTH_KEY, 'true');
        return true;
    }
    return false;
}

function logout() {
    localStorage.removeItem(AUTH_KEY);
    showLoginPage();
}

function showLoginPage() {
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('appContainer').style.display = 'none';
    document.getElementById('loginForm').reset();
}

function showApp() {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('appContainer').style.display = 'flex';
    initializeApp();
}

/* ==================== BLOK 4: FUNGSI DATA DEMO ==================== */
function generateDemoData() {
    // Data demo tetap sama...
    const urls = [
        {
            id: '1',
            originalUrl: 'https://example.com/blog/very-long-article-title-about-web-development',
            slug: 'webdev',
            shortUrl: `${window.location.origin}?go=webdev`,
            createdAt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
            clicks: 342
        },
        {
            id: '2', 
            originalUrl: 'https://example.com/products/special-offer-limited-time-only',
            slug: 'special',
            shortUrl: `${window.location.origin}?go=special`,
            createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
            clicks: 218
        },
        {
            id: '3',
            originalUrl: 'https://example.com/events/annual-conference-2023',
            slug: 'conf2023',
            shortUrl: `${window.location.origin}?go=conf2023`,
            createdAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
            clicks: 156
        }
    ];

    const clicks = [
        { id: '1', urlId: '1', timestamp: new Date().toISOString(), ip: '192.168.1.1', location: 'Jakarta, Indonesia', device: 'Mobile', browser: 'Chrome' },
        { id: '2', urlId: '1', timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(), ip: '192.168.1.2', location: 'Bandung, Indonesia', device: 'Desktop', browser: 'Firefox' },
        { id: '3', urlId: '2', timestamp: new Date(Date.now() - 5 * 60 * 60 * 1000).toISOString(), ip: '192.168.1.3', location: 'Surabaya, Indonesia', device: 'Tablet', browser: 'Safari' },
        { id: '4', urlId: '3', timestamp: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(), ip: '192.168.1.4', location: 'Medan, Indonesia', device: 'Mobile', browser: 'Chrome' },
        { id: '5', urlId: '1', timestamp: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(), ip: '192.168.1.5', location: 'Yogyakarta, Indonesia', device: 'Desktop', browser: 'Edge' }
    ];

    const analytics = {
        totalClicks: 1248,
        uniqueVisitors: 842,
        clickRate: '4.2%',
        clicksLast7Days: [45, 52, 38, 65, 72, 48, 56],
        devices: { mobile: 65, desktop: 25, tablet: 10 },
        browsers: { chrome: 55, firefox: 20, safari: 15, edge: 10 }
    };

    if (!localStorage.getItem(STORAGE_KEY)) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(urls));
    }
    if (!localStorage.getItem(CLICKS_KEY)) {
        localStorage.setItem(CLICKS_KEY, JSON.stringify(clicks));
    }
    if (!localStorage.getItem(ANALYTICS_KEY)) {
        localStorage.setItem(ANALYTICS_KEY, JSON.stringify(analytics));
    }
}

/* ==================== BLOK 5: FUNGSI MANAJEMEN DATA ==================== */
function getUrls() {
    const urls = localStorage.getItem(STORAGE_KEY);
    return urls ? JSON.parse(urls) : [];
}

function getClicks() {
    const clicks = localStorage.getItem(CLICKS_KEY);
    return clicks ? JSON.parse(clicks) : [];
}

function getAnalytics() {
    const analytics = localStorage.getItem(ANALYTICS_KEY);
    return analytics ? JSON.parse(analytics) : {};
}

function saveUrls(urls) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(urls));
}

function saveClicks(clicks) {
    localStorage.setItem(CLICKS_KEY, JSON.stringify(clicks));
}

/* ==================== BLOK 6: FUNGSI UTILITAS ==================== */
function generateRandomSlug(length = 6) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

/* ==================== BLOK 7: FUNGSI URL SHORTENER - YANG DIPERBAIKI ==================== */
function shortenUrl(originalUrl, customSlug = '') {
    const urls = getUrls();
    
    // Validasi URL
    try {
        new URL(originalUrl);
    } catch (e) {
        throw new Error('URL tidak valid');
    }
    
    // Tentukan slug
    let slug = customSlug.trim();
    
    if (!slug) {
        slug = generateRandomSlug();
    } else {
        // Validasi slug
        if (!/^[a-zA-Z0-9_-]+$/.test(slug)) {
            throw new Error('Slug hanya boleh mengandung huruf, angka, tanda hubung, dan garis bawah');
        }
        
        // Cek apakah slug sudah digunakan
        if (urls.some(url => url.slug === slug)) {
            throw new Error('Slug sudah digunakan, coba yang lain');
        }
    }
    
    // PERBAIKAN: Selalu gunakan format ?go=slug untuk GitHub Pages
    const shortUrl = `${window.location.origin}?go=${slug}`;
    
    // Simpan ke daftar URL
    const newUrl = {
        id: Date.now().toString(),
        originalUrl,
        slug,
        shortUrl,
        createdAt: new Date().toISOString(),
        clicks: 0
    };
    
    urls.unshift(newUrl);
    saveUrls(urls);
    
    return newUrl;
}

/* ==================== BLOK 8: FUNGSI TRACKING KLIK ==================== */
function recordClick(urlId) {
    const clicks = getClicks();
    const urls = getUrls();
    
    // Cari URL dan tingkatkan jumlah klik
    const urlIndex = urls.findIndex(url => url.id === urlId);
    if (urlIndex !== -1) {
        urls[urlIndex].clicks += 1;
        saveUrls(urls);
    }
    
    // Generate data klik acak
    const locations = ['Jakarta, Indonesia', 'Bandung, Indonesia', 'Surabaya, Indonesia', 'Medan, Indonesia', 'Yogyakarta, Indonesia'];
    const devices = ['Mobile', 'Desktop', 'Tablet'];
    const browsers = ['Chrome', 'Firefox', 'Safari', 'Edge'];
    
    const newClick = {
        id: Date.now().toString(),
        urlId,
        timestamp: new Date().toISOString(),
        ip: `192.168.1.${Math.floor(Math.random() * 100) + 1}`,
        location: locations[Math.floor(Math.random() * locations.length)],
        device: devices[Math.floor(Math.random() * devices.length)],
        browser: browsers[Math.floor(Math.random() * browsers.length)]
    };
    
    clicks.unshift(newClick);
    saveClicks(clicks);
    
    return newClick;
}

/* ==================== BLOK 9: FUNGSI MANAJEMEN URL ==================== */
function deleteUrl(id) {
    const urls = getUrls();
    const filteredUrls = urls.filter(url => url.id !== id);
    saveUrls(filteredUrls);
    renderUrlList();
    updateDashboard();
}

/* ==================== BLOK 10: FUNGSI RENDER UI ==================== */
function renderUrlList() {
    const urlsContainer = document.getElementById('urls-container');
    const urls = getUrls();
    
    if (urls.length === 0) {
        urlsContainer.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 2rem;">Belum ada URL yang dipersingkat</p>';
        return;
    }
    
    urlsContainer.innerHTML = urls.map(url => `
        <div class="url-item">
            <div class="url-info">
                <div class="original">${url.originalUrl}</div>
                <div class="short">${url.shortUrl}</div>
                <div class="url-stats">
                    <div class="stat">
                        <i class="fas fa-mouse"></i>
                        <span>${url.clicks} klik</span>
                    </div>
                    <div class="stat">
                        <i class="fas fa-calendar"></i>
                        <span>${new Date(url.createdAt).toLocaleDateString('id-ID')}</span>
                    </div>
                </div>
            </div>
            <div class="url-actions">
                <button class="action-btn copy-item-btn" data-url="${url.shortUrl}">
                    <i class="fas fa-copy"></i>
                </button>
                <button class="action-btn" onclick="testUrl('${url.id}')">
                    <i class="fas fa-external-link-alt"></i>
                </button>
                <button class="action-btn btn-warning delete-btn" data-id="${url.id}">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
    
    // Tambahkan event listener untuk tombol salin
    document.querySelectorAll('.copy-item-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const url = this.getAttribute('data-url');
            navigator.clipboard.writeText(url).then(() => {
                const originalHTML = this.innerHTML;
                this.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    this.innerHTML = originalHTML;
                }, 2000);
            });
        });
    });
    
    // Tambahkan event listener untuk tombol hapus
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            if (confirm('Apakah Anda yakin ingin menghapus URL ini?')) {
                deleteUrl(id);
            }
        });
    });
}

/* ==================== BLOK 11: FUNGSI TEST URL ==================== */
function testUrl(id) {
    recordClick(id);
    updateDashboard();
    alert('Klik berhasil dicatat!');
}

/* ==================== BLOK 12: FUNGSI UPDATE DASHBOARD ==================== */
function updateDashboard() {
    const urls = getUrls();
    const clicks = getClicks();
    const analytics = getAnalytics();
    
    // Update statistik
    document.getElementById('totalUrls').textContent = urls.length;
    document.getElementById('totalClicks').textContent = analytics.totalClicks.toLocaleString();
    document.getElementById('uniqueVisitors').textContent = analytics.uniqueVisitors.toLocaleString();
    document.getElementById('clickRate').textContent = analytics.clickRate;
    
    // Update URL terpopuler
    const popularUrlsContainer = document.getElementById('popularUrls');
    const sortedUrls = [...urls].sort((a, b) => b.clicks - a.clicks).slice(0, 5);
    
    if (sortedUrls.length === 0) {
        popularUrlsContainer.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 1rem;">Belum ada URL yang dipersingkat</p>';
    } else {
        popularUrlsContainer.innerHTML = sortedUrls.map(url => `
            <div class="url-item">
                <div class="url-info">
                    <div class="original">${url.originalUrl}</div>
                    <div class="short">${url.shortUrl}</div>
                    <div class="url-stats">
                        <div class="stat">
                            <i class="fas fa-mouse"></i>
                            <span>${url.clicks} klik</span>
                        </div>
                    </div>
                </div>
                <div class="url-actions">
                    <button class="action-btn copy-item-btn" data-url="${url.shortUrl}">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
        `).join('');
        
        // Tambahkan event listener untuk tombol salin di URL populer
        document.querySelectorAll('#popularUrls .copy-item-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const url = this.getAttribute('data-url');
                navigator.clipboard.writeText(url).then(() => {
                    const originalHTML = this.innerHTML;
                    this.innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => {
                        this.innerHTML = originalHTML;
                    }, 2000);
                });
            });
        });
    }
    
    // Update tabel riwayat klik
    const clickHistoryTable = document.getElementById('clickHistoryTable');
    const recentClicks = clicks.slice(0, 10);
    
    if (recentClicks.length === 0) {
        clickHistoryTable.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--gray); padding: 1rem;">Belum ada data klik</td></tr>';
    } else {
        clickHistoryTable.innerHTML = recentClicks.map(click => {
            const url = urls.find(u => u.id === click.urlId);
            return `
                <tr>
                    <td>${new Date(click.timestamp).toLocaleString('id-ID')}</td>
                    <td>${url ? url.shortUrl : 'URL tidak ditemukan'}</td>
                    <td>${click.ip}</td>
                    <td>${click.location}</td>
                    <td><span class="badge badge-info">${click.device}</span></td>
                    <td><span class="badge badge-success">${click.browser}</span></td>
                </tr>
            `;
        }).join('');
    }
    
    // Update chart
    updateCharts();
}

/* ==================== BLOK 13: FUNGSI UPDATE CHART ==================== */
function updateCharts() {
    const analytics = getAnalytics();
    
    // Chart klik
    if (clickChart) {
        clickChart.destroy();
    }
    
    const clickCtx = document.getElementById('clickChart').getContext('2d');
    clickChart = new Chart(clickCtx, {
        type: 'line',
        data: {
            labels: ['6 Hari Lalu', '5 Hari Lalu', '4 Hari Lalu', '3 Hari Lalu', '2 Hari Lalu', 'Kemarin', 'Hari Ini'],
            datasets: [{
                label: 'Klik',
                data: analytics.clicksLast7Days,
                borderColor: '#4361ee',
                backgroundColor: 'rgba(67, 97, 238, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
    
    // Chart analytics
    if (analyticsChart) {
        analyticsChart.destroy();
    }
    
    const analyticsCtx = document.getElementById('analyticsChart').getContext('2d');
    analyticsChart = new Chart(analyticsCtx, {
        type: 'bar',
        data: {
            labels: ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'],
            datasets: [{
                label: 'Klik',
                data: [45, 52, 38, 65, 72, 48, 56],
                backgroundColor: '#4895ef',
                borderColor: '#4361ee',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
    
    // Chart perangkat
    if (deviceChart) {
        deviceChart.destroy();
    }
    
    const deviceCtx = document.getElementById('deviceChart').getContext('2d');
    deviceChart = new Chart(deviceCtx, {
        type: 'doughnut',
        data: {
            labels: ['Mobile', 'Desktop', 'Tablet'],
            datasets: [{
                data: [65, 25, 10],
                backgroundColor: [
                    '#4361ee',
                    '#4895ef',
                    '#4cc9f0'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

/* ==================== BLOK 14: FUNGSI INISIALISASI APLIKASI ==================== */
function initializeApp() {
    // Generate data demo jika diperlukan
    generateDemoData();
    
    // Render data awal
    renderUrlList();
    updateDashboard();
    
    // Navigasi menu
    document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', function() {
            const target = this.getAttribute('data-target');
            
            // Update menu item aktif
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
            
            // Update section konten aktif
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(target).classList.add('active');
            
            // Tutup sidebar mobile jika terbuka
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
            }
        });
    });
    
    // Toggle menu mobile
    document.getElementById('mobileMenuBtn').addEventListener('click', function() {
        document.getElementById('sidebar').classList.toggle('active');
    });
    
    // Event listener untuk tombol persingkat URL
    document.getElementById('shorten-btn').addEventListener('click', function() {
        const originalUrl = document.getElementById('original-url').value.trim();
        const customSlug = document.getElementById('custom-slug').value.trim();
        
        if (!originalUrl) {
            alert('Masukkan URL asli terlebih dahulu');
            return;
        }
        
        try {
            const result = shortenUrl(originalUrl, customSlug);
            
            // Tampilkan hasil
            document.getElementById('short-url-output').value = result.shortUrl;
            document.getElementById('result').style.display = 'block';
            
            // Reset form
            document.getElementById('original-url').value = '';
            document.getElementById('custom-slug').value = '';
            
            // Update tampilan
            renderUrlList();
            updateDashboard();
            
        } catch (error) {
            alert('Error: ' + error.message);
        }
    });
    
    // Tombol salin
    document.getElementById('copy-btn').addEventListener('click', function() {
        const shortUrlInput = document.getElementById('short-url-output');
        shortUrlInput.select();
        navigator.clipboard.writeText(shortUrlInput.value).then(() => {
            const originalHTML = this.innerHTML;
            this.innerHTML = '<i class="fas fa-check"></i> Tersalin!';
            setTimeout(() => {
                this.innerHTML = originalHTML;
            }, 2000);
        });
    });
    
    // Dukungan tombol Enter
    document.getElementById('original-url').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('shorten-btn').click();
        }
    });
    
    document.getElementById('custom-slug').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('shorten-btn').click();
        }
    });
}

/* ==================== BLOK 15: FUNGSI REDIRECT YANG DIPERBAIKI ==================== */
function handleRedirect() {
    // Cek jika ada parameter 'go' di URL
    const urlParams = new URLSearchParams(window.location.search);
    const redirectSlug = urlParams.get('go');
    
    console.log('Checking redirect for slug:', redirectSlug); // Debug
    
    if (redirectSlug) {
        // Cari URL berdasarkan slug di localStorage
        const urls = getUrls();
        console.log('Available URLs:', urls); // Debug
        
        const url = urls.find(u => u.slug === redirectSlug);
        console.log('Found URL:', url); // Debug
        
        if (url) {
            // Catat klik
            const urlIndex = urls.findIndex(u => u.slug === redirectSlug);
            if (urlIndex !== -1) {
                urls[urlIndex].clicks += 1;
                saveUrls(urls);
            }
            
            // PERBAIKAN: Redirect menggunakan window.location.replace
            console.log('Redirecting to:', url.originalUrl);
            window.location.replace(url.originalUrl);
            return true;
        } else {
            // Tampilkan error page
            document.body.innerHTML = `
                <div style="text-align: center; padding: 2rem; font-family: Arial, sans-serif;">
                    <h1 style="color: #e74c3c;">⚠️ URL Tidak Ditemukan</h1>
                    <p>Short URL <strong>${redirectSlug}</strong> tidak valid atau telah dihapus.</p>
                    <a href="${window.location.origin}" style="color: #4361ee; text-decoration: none;">Kembali ke Beranda</a>
                </div>
            `;
            return true;
        }
    }
    return false;
}

/* ==================== BLOK 16: INISIALISASI APLIKASI SAAT HALAMAN DIMUAT ==================== */
document.addEventListener('DOMContentLoaded', function() {
    // PERBAIKAN: Cek redirect SEBELUM cek auth
    if (handleRedirect()) {
        return; // Hentikan eksekusi jika sedang melakukan redirect
    }
    
    // Expose fungsi ke global scope
    window.testUrl = testUrl;
    window.shortenUrl = shortenUrl;
    
    // Cek apakah user sudah login
    if (checkAuth()) {
        showApp();
    } else {
        showLoginPage();
    }
    
    // Submit form login
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        if (login(username, password)) {
            showApp();
        } else {
            alert('Username atau password salah!');
        }
    });
    
    // Tombol logout
    document.getElementById('logoutBtn').addEventListener('click', function() {
        logout();
    });
});
